# DCA Simulator - Comprehensive Bugs and Flaws Report

**Date:** November 25, 2025
**Generated by:** Comprehensive Test Suite Analysis
**Test Coverage:** 30 specialized flaw detection tests

---

## Executive Summary

After thorough analysis of the codebase against the PRD requirements, **19 significant flaws** were identified across code quality, financial accuracy, and edge case handling. The issues range from minor code duplication to critical bugs that could cause crashes with real market data.

**Severity Breakdown:**
- **CRITICAL (4 flaws):** Could cause runtime errors or crashes
- **HIGH (6 flaws):** Logic errors affecting financial accuracy
- **MEDIUM (6 flaws):** Code quality issues and potential edge cases
- **LOW (3 flaws):** Minor inconsistencies and optimizations

---

## CRITICAL SEVERITY ISSUES

### 1. Empty Price Data Crash (NaN Handling)
**Location:** `app.py:50`, price calculation loop
**Status:** ‚ö†Ô∏è **CRITICAL BUG**

**Problem:**
- Code checks `if hist.empty` but doesn't validate for NaN prices
- If Yahoo Finance returns data with missing prices (common during halts/delisting), calculation crashes
- Error: `unsupported operand type(s) for /: 'int' and 'NoneType'`

**Evidence:**
```python
# Test shows crash with NaN prices
test_flaw_empty_price_data ... Error calculating for TEST: unsupported operand type(s) for /: 'int' and 'NoneType'
```

**Impact:**
Users simulating delisted/halted stocks will get 500 errors instead of graceful handling

**Recommendation:**
Add NaN validation:
```python
if hist.empty or hist['Close'].isnull().any():
    return None
```

---

### 2. Interest Not Charged When Expected
**Location:** `app.py:162-187`
**Status:** ‚ö†Ô∏è **CRITICAL BUG**

**Problem:**
- Interest only charged when `current_month != last_interest_month`
- If simulation starts mid-month and user borrows immediately, **NO interest is charged for that first partial month**
- Example: Start Jan 15, borrow $10k, simulation ends Jan 31 ‚Üí $0 interest charged

**Evidence:**
```
test_flaw_interest_charged_on_first_day_of_month ... FAIL
AssertionError: 0.0 not greater than 0 : Should charge interest when month changes
```

**Impact:**
Underestimates interest costs when simulations don't start on first of month. Users get unrealistic margin performance projections.

**Recommendation:**
Charge prorated interest for partial months or document this limitation clearly in UI.

---

### 3. Invalid Input Validation Missing
**Location:** Throughout `calculate_dca_core()` and `/calculate` endpoint
**Status:** ‚ö†Ô∏è **CRITICAL BUG**

**Problem:**
- No validation for negative investment amounts
- No validation for invalid margin ratios (< 1.0)
- Negative amounts would buy negative shares (gibberish results)
- Margin ratio < 1.0 creates nonsensical buying power calculations

**Evidence:**
```python
test_invalid_margin_ratio ... ok  # No error raised, invalid input accepted
test_negative_amounts ... ok  # No error raised, negative amounts accepted
```

**Impact:**
Bad user input or API misuse causes wrong results without error messages

**Recommendation:**
Add input validation at endpoint:
```python
if amount < 0 or initial_amount < 0:
    return jsonify({'error': 'Investment amounts must be positive'}), 400
if margin_ratio < 1.0 or margin_ratio > 2.0:
    return jsonify({'error': 'Margin ratio must be between 1.0 and 2.0'}), 400
```

---

### 4. Dividend Date Alignment Fragility
**Location:** `app.py:63-70`, `app.py:139`
**Status:** ‚ö†Ô∏è **HIGH SEVERITY**

**Problem:**
- Dividend lookup uses string matching: `dividends.get(date_str)`
- If dividend index format doesn't match exactly, dividends are **silently ignored**
- Error messages show: `DEBUG: Error slicing dividends: cannot do slice indexing on RangeIndex`

**Evidence:**
Repeated errors in test output:
```
DEBUG: Error slicing dividends: cannot do slice indexing on RangeIndex with these indexers [2024-01-01] of type str
```

**Impact:**
Real dividend data might be missed without user awareness, causing incorrect reinvestment calculations

**Recommendation:**
Robust date alignment:
```python
# Ensure dividends index is DatetimeIndex before slicing
if not isinstance(dividends.index, pd.DatetimeIndex):
    dividends.index = pd.to_datetime(dividends.index)
```

---

## HIGH SEVERITY ISSUES

### 5. Duplicate Variable Initialization
**Location:** `app.py:93-94`
**Status:** üü† **CODE QUALITY**

**Problem:**
```python
total_invested = 0
total_invested = 0  # Duplicated line
```

**Impact:**
Suggests copy-paste error. No functional impact but indicates careless editing.

**Recommendation:** Remove duplicate line

---

### 6. Duplicate Dictionary Keys
**Location:** `app.py:397-398`, `app.py:415-417`
**Status:** üü† **CODE QUALITY**

**Problem:**
```python
# Line 397-398
'net_portfolio': net_portfolio_values,
'net_portfolio': net_portfolio_values,  # Duplicate

# Line 415-417 in summary dict
'current_leverage': round(current_leverage, 2),
'margin_calls': margin_calls_triggered,
'current_leverage': round(current_leverage, 2),  # Duplicate
'margin_calls': margin_calls_triggered,  # Duplicate
```

**Impact:**
Second assignment overwrites first (Python dict behavior). First assignments are useless code.

**Recommendation:** Remove all duplicate keys

---

### 7. Negative Cash Balance Possible
**Location:** `app.py:175-186`
**Status:** üü° **MEDIUM SEVERITY**

**Problem:**
- When interest charge exceeds available cash, code caps at 0 then adds unpaid to debt
- But between operations, `current_balance` could temporarily go negative in edge cases
- Inconsistent with accounting principle that cash can't be negative

**Impact:**
Minor accounting inconsistency. Unlikely to affect end results but violates domain model.

**Recommendation:**
Ensure `current_balance = max(0, current_balance)` after all cash operations

---

### 8. Equity Calculation Inconsistency
**Location:** `app.py:214` vs `app.py:308`
**Status:** üü° **MEDIUM SEVERITY**

**Problem:**
```python
# Line 214: Uses max(0, current_balance)
current_equity = current_portfolio_value + max(0, current_balance) - borrowed_amount

# Line 308: Uses current_balance directly
current_equity = current_portfolio_value + current_balance - borrowed_amount
```

**Impact:**
If balance is negative, equity calculations differ. Could cause margin call logic errors.

**Recommendation:**
Use `max(0, current_balance)` consistently in both places

---

### 9. Benchmark Uses Same Margin Ratio
**Location:** `app.py:457`
**Status:** üü° **MEDIUM SEVERITY - DESIGN FLAW**

**Problem:**
- When comparing performance with margin enabled, benchmark ticker ALSO uses margin
- This makes comparison less useful - users want to see margin impact vs non-margin
- PRD doesn't explicitly specify, but typically benchmarks should be apples-to-apples

**Current Code:**
```python
benchmark_result = calculate_dca_core(
    benchmark_ticker, ...,
    margin_ratio=margin_ratio  # Uses SAME margin as main
)
```

**Impact:**
Benchmark comparison doesn't isolate margin impact from ticker selection

**Recommendation:**
Consider always running benchmark with `margin_ratio=1.0` for fair comparison, OR add a toggle in UI

---

### 10. Available Principal Initialization Confusing
**Location:** `app.py:96`
**Status:** üü° **MEDIUM SEVERITY**

**Problem:**
```python
available_principal = account_balance if account_balance is not None else 0
```

- In infinite cash mode (`account_balance=None`), sets `available_principal=0`
- But later code at line 273 has separate check for `if account_balance is None`
- Confusing logic flow - why set to 0 if we're going to check None separately?

**Impact:**
No functional bug, but makes code hard to follow and maintain

**Recommendation:**
Clarify intent with comments or restructure:
```python
# Track principal separately from total account balance
# In infinite cash mode, principal tracking is disabled
available_principal = account_balance if account_balance is not None else float('inf')
```

---

## MEDIUM SEVERITY ISSUES

### 11. Rounding Accumulation Over Long Simulations
**Location:** `app.py:356-375`
**Status:** üü¢ **LOW PRIORITY**

**Problem:**
- All values rounded to 2 decimal places when appended to time-series arrays
- Over 1000+ day simulations, rounding errors could accumulate

**Impact:**
Minor drift in multi-year simulations. Tested with 1000-day simulation - drift < $0.01

**Recommendation:**
Store raw values in time series, round only for display in summary

---

### 12. No Validation for Maintenance Margin
**Location:** Function parameters
**Status:** üü¢ **LOW PRIORITY**

**Problem:**
- `maintenance_margin` parameter not validated
- Could pass 0, negative, or > 1.0 causing mathematical errors

**Impact:**
Internal API only - frontend sends fixed 0.25. Low risk unless API is used externally

**Recommendation:**
Add assertion:
```python
assert 0 < maintenance_margin < 1.0, "Maintenance margin must be between 0 and 1"
```

---

### 13. Margin Call Formula Assumes Positive Cash
**Location:** `app.py:326`
**Status:** üü¢ **LOW PRIORITY**

**Problem:**
```python
target_portfolio_value = (borrowed_amount - current_balance) / (1 - maintenance_margin)
```

- If `current_balance` is negative (shouldn't happen but could in edge case), formula breaks
- Would calculate wrong target, potentially over-liquidating

**Impact:**
Theoretical issue - cash balance shouldn't go negative if other fixes applied

**Recommendation:**
Add safety check:
```python
target_portfolio_value = (borrowed_amount - max(0, current_balance)) / (1 - maintenance_margin)
```

---

## MINOR / INFORMATIONAL ISSUES

### 14. Order of Operations Not Documented
**Location:** Main calculation loop
**Status:** ‚ÑπÔ∏è **INFORMATIONAL**

**Observation:**
Daily order is: Dividends ‚Üí Interest ‚Üí Buy ‚Üí Margin Call
This is CORRECT per PRD but not documented in comments

**Recommendation:**
Add comment at loop start:
```python
# Daily order of operations:
# 1. Process dividends (based on shares held from previous day)
# 2. Charge monthly interest (first day of new month)
# 3. Execute daily purchase
# 4. Check and handle margin calls
```

---

### 15. Average Cost After Forced Liquidation
**Location:** Conceptual
**Status:** ‚ÑπÔ∏è **INFORMATIONAL**

**Observation:**
After forced liquidation, average cost doesn't change (correct)
But users might expect it to reflect "average of remaining shares"
Current implementation is technically correct - shows avg cost of all purchases

**Recommendation:**
Add tooltip in UI: "Average cost per share across all purchases (including sold shares)"

---

### 16. ROI with Zero Investment Edge Case
**Location:** `app.py:410`
**Status:** ‚ÑπÔ∏è **INFORMATIONAL**

**Observation:**
If `total_invested = 0` (only dividends received, no purchases), ROI = 0
This is misleading - user has gains but ROI shows 0%

**Recommendation:**
Return special message: `"N/A - No principal invested"` when `total_invested = 0`

---

### 17. Unused Variables and Dead Code
**Location:** `app.py:283-296`
**Status:** ‚ÑπÔ∏è **INFORMATIONAL**

**Problem:**
```python
amount_from_principal = 0
# ... calculate amount_from_principal ...
# ... then never used again
pass  # Empty block with just comments
```

**Impact:**
None - variable is correctly calculated but comments suggest abandoned refactoring

**Recommendation:**
Clean up comments or remove unused variable

---

## ISSUES IN TEST SUITE

### 18. Test Date Alignment Error
**Location:** Multiple tests
**Status:** ‚ö†Ô∏è **TEST BUG**

**Problem:**
Tests create mock dividends with string dates but pd.Series has RangeIndex
Causes repeated errors: `cannot do slice indexing on RangeIndex`

**Impact:**
Tests still pass but error messages clutter output

**Recommendation:**
Fix mock setup:
```python
div_series = pd.Series(dtype=float, index=[])  # Empty DatetimeIndex
for date_str, value in dividends.items():
    div_series[pd.to_datetime(date_str)] = value
```

---

### 19. Fed Funds Rate Test Fragility
**Location:** `test_comprehensive_flaws.py:567`
**Status:** ‚ö†Ô∏è **TEST BUG**

**Problem:**
Can't mock pandas DataFrame.index attribute properly
Test fails with `NotImplementedError: __delete__`

**Recommendation:**
Use different mocking strategy or test at higher level

---

## SUMMARY STATISTICS

| Severity | Count | Fixed | Remaining |
|----------|-------|-------|-----------|
| Critical | 4 | 0 | 4 |
| High | 6 | 0 | 6 |
| Medium | 6 | 0 | 6 |
| Low | 3 | 0 | 3 |
| **TOTAL** | **19** | **0** | **19** |

---

## UNNECESSARY FILES IDENTIFIED

The following files should be considered for removal:

1. **`TDD_COMPLIANCE_REPORT.md`** - Development artifact, not needed in production
2. **`TEST_COVERAGE_SUMMARY.md`** - Development artifact, not needed in production
3. **`__pycache__/` directories** - Should be in `.gitignore`, not committed

**Recommendation:**
Create `.gitignore` with:
```
__pycache__/
*.pyc
*.pyo
venv/
.pytest_cache/
*.egg-info/
```

---

## RECOMMENDATIONS PRIORITY

### Immediate (Before Next Release):
1. Fix NaN price handling (Critical #1)
2. Fix interest calculation for partial months (Critical #2)
3. Add input validation (Critical #3)
4. Fix dividend date alignment (Critical #4)
5. Remove duplicate code (High #5, #6)

### Short Term (Next Sprint):
6. Fix equity calculation inconsistency (High #8)
7. Fix negative balance edge case (High #7)
8. Review benchmark margin behavior (High #9)
9. Add order-of-operations documentation (Medium #14)

### Long Term (Future Enhancement):
10. Improve test suite mocking (Low priority)
11. Add UI tooltips for edge cases (Low priority)
12. Consider rounding strategy for very long simulations (Low priority)

---

**End of Report**
